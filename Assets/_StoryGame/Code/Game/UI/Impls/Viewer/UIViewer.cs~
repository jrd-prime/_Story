using System;
using System.Collections.Generic;
using System.Runtime.CompilerServices.Game;
using _StoryGame.Core.Common.Interfaces;
using _StoryGame.Core.HSM.Impls.States;
using _StoryGame.Core.UI.Interfaces;
using _StoryGame.Data.Const;
using _StoryGame.Game.Extensions;
using _StoryGame.Game.Interact.Systems.Inspect;
using _StoryGame.Game.UI.Abstract;
using _StoryGame.Game.UI.Impls.Viewer.Layers.Back;
using _StoryGame.Game.UI.Impls.Viewer.Layers.Floating;
using _StoryGame.Game.UI.Impls.Viewer.Layers.HUD;
using _StoryGame.Game.UI.Impls.Viewer.Layers.Movement;
using _StoryGame.Game.UI.Impls.Viewer.Messages;
using MessagePipe;
using R3;
using UnityEngine;
using UnityEngine.UIElements;
using VContainer;
using IUIViewer = _StoryGame.Game.UI.Interfaces.IUIViewer;

namespace _StoryGame.Game.UI.Impls.Viewer
{
    [RequireComponent(typeof(UIDocument))]
    public sealed class UIViewer : MonoBehaviour, IUIViewer
    {
        private const string LayerBackId = "layer-back";
        private const string LayerMovementId = "layer-movement";
        private const string LayerHudId = "layer-hud";
        private const string LayerFloatingId = "layer-floating";

        private IObjectResolver _resolver;
        private IJLog _log;

        private BackLayerHandler _backLayerHandler;
        private MovementLayerHandler _movementLayerHandler;
        private HUDLayerHandler _hudLayerHandler;
        private FloatingLayerHandler _floatingLayerHandler;

        private bool _isInitialized;
        private VisualElement _mainContainer;

        private readonly Dictionary<EGameStateType, TemplateContainer> _viewsCache = new();
        private readonly CompositeDisposable _disposables = new();

        [Inject]
        private void Construct(IObjectResolver resolver, ISubscriber<IUIViewerMsg> subscriber)
        {
            _resolver = resolver;
            _log = resolver.Resolve<IJLog>();

            subscriber
                .Subscribe(OnMessage)
                .AddTo(_disposables);
        }

        private void OnMessage(IUIViewerMsg message)
        {
            switch (message)
            {
                case InitializeViewerMsg msg:
                    Initialize(msg.Views);
                    break;
                case SwitchBaseViewMsg msg:
                    SwitchBaseViewTo(msg.StateType);
                    break;
                case ShowHasLootWindowMsg msg:
                    _floatingLayerHandler.ShowHasLootWindow(msg);
                    break;
                case ShowNoLootWindowMsg msg:
                    _floatingLayerHandler.ShowNoLootWindow(msg);
                    break;
                case ShowLootWindowMsg msg:
                    _floatingLayerHandler.ShowLootWindow(msg);
                    break;
                case ShowNewNoteMsg msg:
                    _floatingLayerHandler.ShowNewNote(msg);
                    break;
                case ShowExitRoomWindowMsg msg:
                    _floatingLayerHandler.ShowRoomChooseWindow(msg);
                    break;
                case CurrentOperationMsg msg:
                    _hudLayerHandler.ShowCurrentOperation(msg.CurrentOperation);
                    break;
                case DisplayArtefactInfoMsg msg:
                    _floatingLayerHandler.DisplayArtefactInfoWindow(msg);
                    break;
                case DisplayRoomDraftWindowMsg msg:
                    _floatingLayerHandler.DisplayRoomDraftWindow(msg);
                    break;
                default: throw new ArgumentOutOfRangeException(nameof(message), message, null);
            }
        }

        private async void Awake()
        {
            var document = GetComponent<UIDocument>();
            await document.WaitForReadyAsync();

            var root = document.rootVisualElement;
            root.SetFullScreen();

            var safeZoneOffset = ScreenHelper.GetSafeZoneOffset(1600f, 720f);
            root.style.marginLeft = safeZoneOffset.x >= 16 ? safeZoneOffset.x : 16;
            root.style.marginTop = safeZoneOffset.y;

            _mainContainer = root.GetVElement<VisualElement>(UIConst.MainContainer, name);

            if (_mainContainer == null)
                throw new NullReferenceException($"VisualElement with ID '{UIConst.MainContainer}' not found. " +
                                                 nameof(UIViewer));

            InitializeLayers();
        }

        private void InitializeLayers()
        {
            // Back Layer
            var backLayerRoot = _mainContainer.GetVElement<VisualElement>(LayerBackId, name);
            _backLayerHandler = new BackLayerHandler(_resolver, backLayerRoot);

            // Movement Layer
            var movementLayerRoot = _mainContainer.GetVElement<VisualElement>(LayerMovementId, name);
            _movementLayerHandler = new MovementLayerHandler(_resolver, movementLayerRoot);

            // HUD Layer
            var hudLayerRoot = _mainContainer.GetVElement<VisualElement>(LayerHudId, name);
            _hudLayerHandler = new HUDLayerHandler(_resolver, hudLayerRoot);

            // Floating Layer
            var floatingLayerRoot = _mainContainer.GetVElement<VisualElement>(LayerFloatingId, name);
            _floatingLayerHandler = new FloatingLayerHandler(_resolver, floatingLayerRoot);
        }

        private void Initialize(IDictionary<EGameStateType, AUIViewBase> viewsCache)
        {
            foreach (var view in viewsCache)
            {
                _resolver.Inject(view.Value);
                _viewsCache.TryAdd(view.Key, view.Value.Template);
            }

            _isInitialized = true;
        }

        private void SwitchBaseViewTo(EGameStateType state)
        {
            if (!_isInitialized)
                throw new NullReferenceException("UIViewer is not initialized. " + nameof(SwitchBaseViewTo));

            if (!_viewsCache.TryGetValue(state, out var view))
                throw new NullReferenceException($"No view for state: {state}. " + nameof(SwitchBaseViewTo));

            _log.Info($"SHOW UI FOR: {state}");

            _hudLayerHandler.SwitchViewTo(view);
        }

        private void OnDestroy()
        {
            _isInitialized = false;
            _viewsCache.Clear();
        }
    }
}
