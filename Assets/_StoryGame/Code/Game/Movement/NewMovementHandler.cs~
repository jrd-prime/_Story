using System;
using System.Runtime.CompilerServices;
using _StoryGame.Core.Character.Player.Interfaces;
using _StoryGame.Core.Interfaces;
using _StoryGame.Game.Managers.Inerfaces;
using _StoryGame.Infrastructure.Logging;
using R3;
using UnityEngine;
using UnityEngine.AI;
using UnityEngine.EventSystems;
using VContainer;

namespace _StoryGame.Game.Movement
{
    public sealed class NewMovementHandler : MonoBehaviour, IMovementHandler
    {
        public ReadOnlyReactiveProperty<Vector3> NewMovePosition => _newMovePosition;
        public ReadOnlyReactiveProperty<Vector3> MoveDirection => _moveDirection;
        public ReadOnlyReactiveProperty<bool> IsTouchVisible => _isTouchVisible;
        public ReadOnlyReactiveProperty<Vector2> RingPosition => _ringPosition;


        private bool _isTouchActive;

        private readonly ReactiveProperty<Vector3> _newMovePosition = new(Vector3.zero);
        private readonly ReactiveProperty<Vector3> _moveDirection = new(Vector3.zero);
        private readonly ReactiveProperty<bool> _isTouchVisible = new(false);
        private readonly ReactiveProperty<Vector2> _ringPosition = new(Vector2.zero);

        [SerializeField] private Camera _mainCamera;
        [SerializeField] private LayerMask _interactableLayer;
        [SerializeField] private LayerMask _groundLayer;

        private IJLog _log;
        private IPlayer _player;
        private ICameraManager _cameraManager;
        private Vector2 _startTouchPosition;
        private Vector2 _moveInput;

        [Inject]
        private void Construct(IJLog log, ICameraManager cameraManager)
        {
            _log = log;
            _cameraManager = cameraManager;
        }

        private void Start()
        {
            if (!_mainCamera)
                throw new NullReferenceException($"MainCamera is null. {this}");
        }

        private void Update()
        {
            if (HasNoInput())
                return;

            if (TryGetInputPosition(out var inputPosition))
                HandleInput(inputPosition);
        }

        private static bool TryGetInputPosition(out Vector2 inputPosition)
        {
            inputPosition = default;

#if UNITY_EDITOR || UNITY_STANDALONE
            if (Input.GetMouseButtonDown(0))
            {
                inputPosition = Input.mousePosition;
                return true;
            }
#endif

#if UNITY_ANDROID || UNITY_IOS
            if (Input.touchCount > 0 && Input.GetTouch(0).phase == TouchPhase.Began)
            {
                inputPosition = Input.GetTouch(0).position;
                return true;
            }
#endif

            return false;
        }

        private void HandleInput(Vector2 inputPosition)
        {
            if (_isTouchActive)
                return;

            if (!_mainCamera)
            {
                _log.Error("Cannot process world click: Main Camera is null!");
                ResetTouch();
                return;
            }

            // _log.Debug($"Input detected at screen position: {inputPosition}");

            if (IsClickOverUI())
            {
                // _log.Debug("Click on UI, ignoring.");
                ResetTouch();
                return;
            }

            _isTouchActive = true;
            _startTouchPosition = inputPosition;

            Ray ray = _mainCamera.ScreenPointToRay(inputPosition);
            Debug.DrawRay(ray.origin, ray.direction * 100f, Color.red, 2f);

// Проверяем сначала интерактивный объект
            if (Physics.Raycast(ray, out var hit, Mathf.Infinity, _interactableLayer))
            {
                _log.Debug($"Hit Interactable object: {hit.collider.gameObject.name}");

                var interactable = hit.collider.GetComponent<IInteractable>();
                if (interactable != null)
                {
                    _log.Debug($"Interacted with object: {interactable.Name}");
                    // interactable.Interact();
                }

                ResetTouch();
                return;
            }

// Если нет интерактивного объекта, проверяем NavMesh
            if (Physics.Raycast(ray, out hit, Mathf.Infinity, _groundLayer))
            {
                _log.Debug($"Hit Ground object: {hit.collider.gameObject.name}");

                if (NavMesh.SamplePosition(hit.point, out var navMeshHit, 0.5f, NavMesh.AllAreas))
                {
                    NewPositionForMove(navMeshHit.position);
                }
                else
                {
                    _log.Debug("Clicked position is not valid on NavMesh!");
                }
            }
            else
            {
                _log.Debug("No hit on Ground layer!");
            }

            ResetTouch();
        }

        private void NewPositionForMove(Vector3 position) =>
            _newMovePosition.Value = position;

        private void ResetTouch()
        {
            _isTouchActive = false;
            _moveInput = Vector2.zero;
        }

        #region Conditions

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        private static bool HasNoInput() =>
            !Input.GetMouseButtonDown(0) && Input.touchCount == 0;

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        private static bool IsClickOverUI() =>
            EventSystem.current && EventSystem.current.IsPointerOverGameObject();

        #endregion
    }
}
