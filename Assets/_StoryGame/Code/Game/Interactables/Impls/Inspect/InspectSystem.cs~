using _StoryGame.Core.Interfaces.UI;
using _StoryGame.Game.Interactables.Data;
using _StoryGame.Game.Interactables.Interfaces;
using _StoryGame.Game.Room;
using _StoryGame.Game.UI.Impls.WorldUI;
using _StoryGame.Game.UI.Messages;
using _StoryGame.Infrastructure.Localization;
using _StoryGame.Infrastructure.Logging;
using _StoryGame.Infrastructure.Settings;
using Cysharp.Threading.Tasks;
using MessagePipe;
using UnityEngine;

namespace _StoryGame.Game.Interactables.Impls.Inspect
{
    //TODO NEED REFACTOR (state machine etc)
    public sealed class InspectSystem : IInteractableSystem
    {
        private const float InspectDuration = 2f;
        private const float SearchDuration = 2f;
        private IInspectable _inspectable;

        private readonly IJLog _log;
        private readonly IPublisher<IUIViewerMessage> _uiViewerMsgPub;
        private readonly IPublisher<ShowPlayerActionProgressMsg> _showPlayerActionProgressMsgPub;
        private IRoom _room;
        private string _inspectableId;
        private readonly InspectSystemTipData _settings;
        private readonly ILocalizationProvider _localizationProvider;

        public InspectSystem(
            IJLog log,
            ILocalizationProvider localizationProvider,
            ISettingsProvider settingsProvider,
            IPublisher<IUIViewerMessage> uiViewerMsgPub,
            IPublisher<ShowPlayerActionProgressMsg> showPlayerActionProgressMsgPub
        )
        {
            _log = log;
            _localizationProvider = localizationProvider;
            _settings = settingsProvider.GetSettings<InspectSystemTipData>();
            _uiViewerMsgPub = uiViewerMsgPub;
            _showPlayerActionProgressMsgPub = showPlayerActionProgressMsgPub;
        }

        public async UniTask<bool> Process(IInspectable inspectable)
        {
            _inspectable = inspectable;
            _inspectableId = inspectable.Id;
            _room = inspectable.Room;

            var inspectState = inspectable.InspectState;
            var result = inspectState switch
            {
                EInspectState.NotInspected => await StartInspect(),
                EInspectState.Inspected => await Inspected(),
                EInspectState.Searched => await Searched(),
                _ => false
            };

            await OnInteractionComplete();

            Debug.Log($"Interact <color=green>END</color>. Result: {result}");
            return result;
        }

        private async UniTask<bool> StartInspect()
        {
            _log.Debug("<color=green>Start Inspect</color>".ToUpper());
            await OnStartInspect();
            await Inspected();
            return true;
        }

        private async UniTask<bool> Inspected()
        {
            _log.Debug("<color=green>Inspected</color>".ToUpper());
            await OnCompleteInspect();
            return true;
        }

        private async UniTask<bool> StartSearch()
        {
            _log.Debug("<color=green>Start Search</color>".ToUpper());
            await OnStartSearch();
            await Searched();
            return true;
        }

        private async UniTask<bool> Searched()
        {
            _log.Debug("<color=green>Searched</color>".ToUpper());
            await OnCompleteSearch();
            return true;
        }

        private async UniTask OnInteractionComplete()
        {
            _log.Debug("--- OnInteractionComplete");
            await UniTask.Yield();
        }

        private async UniTask OnStartInspect()
        {
            // anim hero // await progress bar
            _log.Debug("OnStart Inspect");

            var source = new UniTaskCompletionSource<EInteractDialogResult>();
            var message = new ShowPlayerActionProgressMsg("Inspect", InspectDuration, source);
            _showPlayerActionProgressMsgPub.Publish(message);
            await source.Task;
        }

        private async UniTask OnCompleteInspect()
        {
            _log.Debug("OnComplete Inspect");
            _inspectable.SetInspectState(EInspectState.Inspected);
            await ShowLootTipAfterInspect();
        }

        private async UniTask ShowLootTipAfterInspect()
        {
            if (_room.HasLoot(_inspectableId))
            {
                _log.Debug("<color=green>Inspect - has loot</color>");

                var source = new UniTaskCompletionSource<EInteractDialogResult>();
                var lootData = _room.GetLoot(_inspectableId);
                var tipLocalizationId = _settings.GetRandomTip(InspectSystemTipType.HasLoot);
                var tip = _localizationProvider.LocalizeWord(tipLocalizationId);
                var message = new ShowHasLootWindowMsg(tip, lootData, source);

                try
                {
                    _uiViewerMsgPub.Publish(message);
                    var result = await source.Task;
                    source = null;

                    if (result == EInteractDialogResult.Search)
                    {
                        await StartSearch();
                    }
                    else if (result == EInteractDialogResult.Close)
                    {
                        Debug.Log("ShowLootTipAfterInspect - CLOSE");
                    }
                    else _log.Warn("Unhandled result: " + result);
                }
                finally
                {
                    source?.TrySetCanceled();
                }
            }
            else
            {
                _log.Debug("<color=red>Inspect - no loot</color>");

                var source = new UniTaskCompletionSource<EInteractDialogResult>();
                var tipLocalizationId = _settings.GetRandomTip(InspectSystemTipType.NoLoot);
                var tip = _localizationProvider.LocalizeWord(tipLocalizationId);
                var message = new ShowNoLootWindowMsg(tip, source);

                try
                {
                    _uiViewerMsgPub.Publish(message);

                    var result = await source.Task;
                    source = null;

                    if (result == EInteractDialogResult.Close)
                    {
                        Debug.Log("ShowLootTipAfterInspect - CLOSE");
                    }
                    else _log.Warn("Unhandled result: " + result);
                }
                finally
                {
                    source?.TrySetCanceled();
                }
            }
        }

        private async UniTask OnStartSearch()
        {
            _log.Debug("OnStart Search");
            // anim hero // await progress bar
            var source = new UniTaskCompletionSource<EInteractDialogResult>();
            _showPlayerActionProgressMsgPub.Publish(new ShowPlayerActionProgressMsg("Search", SearchDuration,
                source));
            await source.Task;
        }

        private async UniTask OnCompleteSearch()
        {
            _log.Debug("OnComplete Search");
            _inspectable.SetInspectState(EInspectState.Searched);
            await ShowLootTipAfterSearch();
        }

        private async UniTask ShowLootTipAfterSearch()
        {
            Debug.Log("ShowLootTipAfterSearch - wait callback from tip ");

            var source = new UniTaskCompletionSource<EInteractDialogResult>();
            var lootData = _room.GetLoot(_inspectableId);
            var message = new ShowLootWindowMsg(lootData, source);

            try
            {
                _uiViewerMsgPub.Publish(message);

                var result = await source.Task;
                source = null;

                if (result == EInteractDialogResult.TakeAll)
                {
                    Debug.Log("ShowLootTipAfterSearch - TAKE ALL");
                    await OnTakeAllLoot();
                }
                else if (result == EInteractDialogResult.Close)
                {
                    Debug.Log("ShowLootTipAfterSearch - CLOSE");
                }
                else _log.Warn("Unhandled result: " + result);
            }
            finally
            {
                source?.TrySetCanceled();
            }
        }

        private async UniTask OnTakeAllLoot()
        {
            _log.Debug("OnTakeAllLoot");
            await UniTask.Yield();
        }
    }
}
